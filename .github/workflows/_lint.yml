name: 11. _Lint Checks

on:
  workflow_call:
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Required to calculate the git diff

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 'stable'

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Install dependencies
      run: uv sync --frozen --extra dev

    # --- NEW STEP: Get the list of changed files ---
    - name: Get changed Python files
      id: changed-files
      uses: tj-actions/changed-files@v45
      with:
        # Only look for python files inside the openviking folder
        files: |
          openviking/**/*.py
          examples/**/*.py

    # --- UPDATED STEPS: Use the file list ---
    - name: List changed files
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "The following files have changed:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"

    - name: Format with ruff (Changed files only)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: uv run ruff format --check ${{ steps.changed-files.outputs.all_changed_files }}

    - name: Lint with ruff (Changed files only)
      if: steps.changed-files.outputs.any_changed == 'true'
      run: uv run ruff check ${{ steps.changed-files.outputs.all_changed_files }}

    - name: Type check with mypy (Changed files only)
      if: steps.changed-files.outputs.any_changed == 'true'
      # Note: Running mypy on specific files may miss cross-file type errors
      run: uv run mypy ${{ steps.changed-files.outputs.all_changed_files }}
      continue-on-error: true